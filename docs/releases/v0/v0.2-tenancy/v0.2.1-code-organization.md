# v0.2.1 - Code Organization

## Overview
This specification outlines the process of removing organization/multi-tenant code and establishing a clean single-tenant foundation.

## Goals
- ✅ Remove all organization and multi-tenant code
- ✅ Establish clean codebase structure
- Prepare for Clerk authentication integration
- Set up foundation for sync service

## Implementation

### 1. Code Cleanup

#### 1.1 Remove Organization Components ✅
1. Delete organization-specific components:
   - ✅ `features/auth/organization-provider.tsx`
   - ✅ `features/create-organization/index.tsx`
   - ✅ `routes/_authenticated/create-organization/route.lazy.tsx`
   - ✅ `routes/_authenticated/create-organization/index.lazy.tsx`

2. Clean up organization-related routes:
   - ✅ Remove organization routes from `routeTree.gen.ts`
   - ✅ Update route types and interfaces
   - ✅ Remove organization-related route declarations

3. Remove organization API endpoints:
   - ✅ Clean up organization endpoints in `lib/api.ts`
   - ✅ Remove organization-related API types and interfaces
   - ✅ Update API client initialization

#### 1.2 Clean up Layout Components ✅
1. Update team switcher:
   - ✅ Remove `components/layout/team-switcher.tsx`
   - ✅ Update sidebar to remove team switching functionality
   - ✅ Clean up team-related types in `components/layout/types.ts`

2. Update navigation:
   - ✅ Remove organization-specific navigation items
   - ✅ Update route guards and navigation hooks
   - ✅ Clean up navigation types and interfaces

### 2. Authentication Setup

#### 2.1 Configure Clerk Routes
1. Set up auth route structure:
   ```typescript
   // routes/__root.tsx
   import { createRootRoute } from '@tanstack/react-router'
   import { rootAuthLoader } from '@clerk/clerk-react'
   
   export const Route = createRootRoute({
     loader: rootAuthLoader,
     component: RootComponent
   })
   ```

2. Create auth pages:
   - Create `routes/sign-in.tsx` with `<SignIn />` component
   - Create `routes/sign-up.tsx` with `<SignUp />` component
   - Create `routes/otp.tsx` for OTP verification

3. Configure environment:
   ```env
   # API URL for backend services
   VITE_API_URL=http://localhost:8787/api
   
   # Clerk authentication
   VITE_CLERK_PUBLISHABLE_KEY=pk_test_your_publishable_key
   
   # Note: Auth URLs are configured in ClerkProviderWithTheme component
   ```

#### 2.2 Update Clerk Integration
1. Update Clerk provider setup:
   ```typescript
   // lib/clerk.tsx
   export function ClerkProviderWithTheme({ children }: { children: ReactNode }) {
     const { theme } = useTheme()
     return (
       <ClerkProvider
         publishableKey={import.meta.env.VITE_CLERK_PUBLISHABLE_KEY}
         afterSignInUrl="/"
         afterSignUpUrl="/"
         signInUrl="/sign-in"
         signUpUrl="/sign-up"
       >
         {children}
       </ClerkProvider>
     )
   }
   ```

2. Clean up organization-specific Clerk hooks:
   - Remove organization hooks from components
   - Update any components using Clerk organization features
   - Clean up organization-specific auth flows

#### 2.3 Protected Routes
1. Create auth middleware:
   ```typescript
   // middleware/auth.ts
   import { getAuth } from '@clerk/clerk-react'
   
   export async function authMiddleware() {
     const { userId, sessionId } = await getAuth()
     if (!userId) {
       throw redirect('/sign-in')
     }
     return { userId, sessionId }
   }
   ```

2. Apply to routes:
   ```typescript
   // routes/_authenticated/route.lazy.tsx
   export const Route = createLazyFileRoute('/_authenticated')({
     beforeLoad: authMiddleware,
     component: AuthenticatedLayout
   })
   ```

### 3. Application Structure Cleanup

#### 3.1 Clean Up Store Layer
1. Review and update stores:
   - Clean up organization-related state management
   - Update any stores with tenant-specific logic
   - Remove organization selectors and actions

2. Update context providers:
   - Remove organization context providers
   - Clean up tenant-specific contexts
   - Update context consumers

#### 3.2 Update Utility Functions
1. Clean up utility functions:
   - Remove organization-specific utilities
   - Update any helpers dealing with tenant data
   - Clean up type utilities

2. Update hooks:
   - Remove organization-related custom hooks
   - Clean up tenant-specific hook logic
   - Update hook dependencies

### 4. Sync Service Preparation

#### 4.1 Clean up Data Layer
1. Update data models:
   - Remove organization fields from schemas
   - Update database types for single-tenant mode
   - Prepare models for sync service

2. Prepare for webhook integration:
   - Set up webhook handler structure
   - Prepare sync service types
   - Update API endpoints for sync flow

### 5. Route Migration

#### 5.1 TanStack Router Setup
1. Install dependencies:
   ```bash
   npm install @tanstack/react-router @tanstack/router-vite-plugin
   ```

2. Configure Vite plugin:
   ```typescript
   // vite.config.ts
   import { TanStackRouterVite } from '@tanstack/router-vite-plugin'
   
   export default defineConfig({
     plugins: [TanStackRouterVite(), react()]
   })
   ```

3. Set up router instance:
   ```typescript
   // src/main.tsx
   import { createRouter, RouterProvider } from '@tanstack/react-router'
   import { routeTree } from './routeTree.gen'
   
   const router = createRouter({ routeTree })
   
   declare module '@tanstack/react-router' {
     interface Register {
       router: typeof router
     }
   }
   ```

#### 5.2 Route Migration
1. Update main application setup:
   ```typescript
   // main.tsx
   const router = createRouter({
     routeTree,
     context: {
       queryClient,
     },
   })
   
   root.render(
     <React.StrictMode>
       <ThemeProvider defaultTheme='light' storageKey='vite-ui-theme'>
         <ClerkProviderWithTheme>
           <QueryProvider>
             <RouterProvider router={router} />
           </QueryProvider>
         </ClerkProviderWithTheme>
       </ThemeProvider>
     </React.StrictMode>
   )
   ```

2. Update navigation components:
   - Replace React Router `Link` with TanStack Router `Link`
   - Update `useNavigate` imports
   - Update route parameters usage

3. Update route definitions:
   - Convert to file-based routing structure
   - Update search params handling
   - Migrate route params usage

4. Clean up route types:
   - Update route type declarations
   - Clean up route interfaces
   - Update route params types

## Success Criteria
- All organization components successfully removed
- No tenant-related types remain in the codebase
- Clean, simplified codebase structure
- Ready for Clerk authentication integration
- Prepared for sync service implementation
- Successfully migrated to TanStack Router
- Clerk auth flow properly integrated

## Dependencies
- None (first step in v0.2)

## Related Stories
- STORY-3.1: Code Cleanup
- STORY-3.2: User Authentication
- STORY-3.3: Authentication Flow 