# v0.2.4 Authentication Routes

## Overview
This specification outlines the implementation of authentication routes and protected route handling using Clerk.

## Goals
- Set up authentication routes
- Implement protected route handling
- Create auth middleware
- Establish type-safe routing

## Implementation

### 1. Auth Routes

```typescript
// apps/web/src/routes/auth.tsx
import { SignIn, SignUp } from '@clerk/clerk-react'
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/sign-in')({
  component: () => (
    <div className="auth-container">
      <SignIn routing="path" path="/sign-in" />
    </div>
  )
})

export const SignUpRoute = createFileRoute('/sign-up')({
  component: () => (
    <div className="auth-container">
      <SignUp routing="path" path="/sign-up" />
    </div>
  )
})
```

### 2. Protected Route Wrapper

```typescript
// apps/web/src/components/protected-route.tsx
import { useAuth } from '@clerk/clerk-react'
import { Navigate, useLocation } from '@tanstack/react-router'

interface ProtectedRouteProps {
  children: React.ReactNode
}

export function ProtectedRoute({ children }: ProtectedRouteProps) {
  const { isLoaded, isSignedIn } = useAuth()
  const location = useLocation()

  if (!isLoaded) {
    return <div>Loading...</div>
  }

  if (!isSignedIn) {
    return <Navigate to="/sign-in" search={{ redirect: location.pathname }} />
  }

  return <>{children}</>
}
```

### 3. Route Configuration

```typescript
// apps/web/src/routes/__root.tsx
import { createRootRoute } from '@tanstack/react-router'
import { ClerkProvider } from '@clerk/clerk-react'
import { TanStackRouterDevtools } from '@tanstack/router-devtools'

export const Route = createRootRoute({
  component: () => (
    <ClerkProvider publishableKey={process.env.CLERK_PUBLISHABLE_KEY}>
      <Outlet />
      {process.env.NODE_ENV === 'development' && (
        <TanStackRouterDevtools position="bottom-right" />
      )}
    </ClerkProvider>
  )
})

// apps/web/src/routes/_protected.tsx
import { createFileRoute } from '@tanstack/react-router'
import { ProtectedRoute } from '../components/protected-route'

export const Route = createFileRoute('/_protected')({
  component: () => (
    <ProtectedRoute>
      <Outlet />
    </ProtectedRoute>
  )
})
```

### 4. Auth Hooks

```typescript
// apps/web/src/hooks/use-auth.ts
import { useAuth as useClerkAuth } from '@clerk/clerk-react'
import { useNavigate } from '@tanstack/react-router'

export function useAuth() {
  const { isLoaded, isSignedIn, signOut } = useClerkAuth()
  const navigate = useNavigate()

  const handleSignOut = async () => {
    await signOut()
    navigate({ to: '/sign-in' })
  }

  return {
    isLoaded,
    isSignedIn,
    signOut: handleSignOut
  }
}
```

### 5. Auth Types

```typescript
// apps/web/src/types/auth.ts
export interface AuthUser {
  id: string
  email: string
  firstName?: string
  lastName?: string
  imageUrl?: string
}

export interface AuthSession {
  id: string
  userId: string
  lastActiveAt: string
  expireAt: string
}

export interface AuthState {
  isLoaded: boolean
  isSignedIn: boolean
  user: AuthUser | null
  session: AuthSession | null
}
```

## Testing

### 1. Route Tests
```typescript
// apps/web/src/routes/__tests__/auth.test.tsx
import { render, screen } from '@testing-library/react'
import { createMemoryRouter } from '@tanstack/react-router'

describe('Auth Routes', () => {
  it('renders sign in page', () => {
    // Test implementation
  })

  it('renders sign up page', () => {
    // Test implementation
  })
})
```

### 2. Protected Route Tests
```typescript
// apps/web/src/components/__tests__/protected-route.test.tsx
describe('ProtectedRoute', () => {
  it('redirects to sign in when not authenticated', () => {
    // Test implementation
  })

  it('renders children when authenticated', () => {
    // Test implementation
  })
})
```

## Success Criteria
- Authentication routes working correctly
- Protected routes properly guarding content
- Auth middleware functioning
- Type-safe routing implemented
- All tests passing

## Dependencies
- STORY-3.1: Code Cleanup
- STORY-3.2: User Authentication

## Related Stories
- STORY-3.3: Authentication Flow
- STORY-4.1: Sync Service
- STORY-4.2: Testing Infrastructure 